let hedgehogs = [];
let images = [];
let hgbImage;

// Button constants
const BUTTON_WIDTH = 80;
const BUTTON_HEIGHT = 30;
const BUTTON_MARGIN = 10;

function preload() {
  try {
    images.push(loadImage('hg.png'));
    images.push(loadImage('hg2.png'));
    images.push(loadImage('hg5.png'));
    images.push(loadImage('hg6.png'));
    images.push(loadImage('hg7 (1).png'));
    images.push(loadImage('hg7 (2).png'));
    hgbImage = loadImage('hgb.png');
    console.log(`Loaded ${images.length} main images and hgb.png`);
  } catch (e) {
    console.error('Error loading images:', e);
  }
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  images.forEach((img, i) => {
    hedgehogs.push(new Hedgehog(random(width), random(height), i));
  });
}

function draw() {
  background(240);
  for (let hedgehog of hedgehogs) {
    hedgehog.update();
    hedgehog.display();
  }

  // Draw the "MORE!" button
  let buttonX = width - BUTTON_WIDTH - BUTTON_MARGIN;
  let buttonY = BUTTON_MARGIN;
  fill(255, 0, 0);
  rect(buttonX, buttonY, BUTTON_WIDTH, BUTTON_HEIGHT);
  fill(255);
  textAlign(CENTER, CENTER);
  text("MORE!", buttonX + BUTTON_WIDTH / 2, buttonY + BUTTON_HEIGHT / 2);

  // Change cursor when hovering over the button
  if (isMouseOverButton()) {
    cursor(HAND);
  } else {
    cursor(ARROW);
  }
}

function mousePressed() {
  if (isMouseOverButton()) {
    addHedgehogs();
  } else {
    for (let hedgehog of hedgehogs) {
      if (hedgehog.isMouseOver()) {
        hedgehog.toggleImage();
        hedgehog.isClicked = true;
        hedgehog.clickX = mouseX;
        hedgehog.clickY = mouseY;
        hedgehog.offsetX = mouseX - hedgehog.x;
        hedgehog.offsetY = mouseY - hedgehog.y;
      }
    }
  }
}

function mouseDragged() {
  for (let hedgehog of hedgehogs) {
    if (hedgehog.isClicked) {
      let dx = mouseX - hedgehog.clickX;
      let dy = mouseY - hedgehog.clickY;
      if (sqrt(dx * dx + dy * dy) > 5) {
        hedgehog.isDragging = true;
      }
    }
  }
}

function mouseReleased() {
  for (let hedgehog of hedgehogs) {
    if (hedgehog.isDragging || hedgehog.isClicked) {
      hedgehog.isDragging = false;
      hedgehog.isClicked = false;
      hedgehog.vx = random(-9, 9);
      hedgehog.vy = random(-9, 9);
    }
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}

function addHedgehogs() {
  for (let i = 0; i < 3; i++) {
    hedgehogs.push(new Hedgehog(random(width), random(height)));
  }
}

function isMouseOverButton() {
  let buttonX = width - BUTTON_WIDTH - BUTTON_MARGIN;
  let buttonY = BUTTON_MARGIN;
  return mouseX > buttonX && mouseX < buttonX + BUTTON_WIDTH &&
         mouseY > buttonY && mouseY < buttonY + BUTTON_HEIGHT;
}

class Hedgehog {
  constructor(x, y, imgIndex) {
    this.x = x;
    this.y = y;
    this.vx = random(-9, 9);
    this.vy = random(-9, 9);
    this.size = 150;
    this.isDragging = false;
    this.isClicked = false;
    this.offsetX = 0;
    this.offsetY = 0;
    this.clickX = 0;
    this.clickY = 0;
    this.isToggled = false;
    this.toggleTime = 0;
    this.originalImgIndex = imgIndex !== undefined ? imgIndex : floor(random(images.length));
    this.img = images[this.originalImgIndex];
    console.log(`Hedgehog assigned image: ${this.img.src}`);
  }

  toggleImage() {
    if (!this.isToggled) {
      this.img = hgbImage;
      this.isToggled = true;
      this.toggleTime = millis();
      console.log(`Toggled to hgb.png at ${this.toggleTime}ms: ${this.img.src}`);
    }
  }

  update() {
    if (this.isToggled && millis() - this.toggleTime > 1000) {
      this.img = images[this.originalImgIndex];
      this.isToggled = false;
      console.log(`Reverted to original image at ${millis()}ms: ${this.img.src}`);
    }

    if (!this.isDragging) {
      this.x += this.vx;
      this.y += this.vy;
      if (this.x < 0 || this.x > width - this.size) {
        this.vx *= -1;
      }
      if (this.y < 0 || this.y > height - this.size) {
        this.vy *= -1;
      }
    } else {
      this.x = mouseX - this.offsetX;
      this.y = mouseY - this.offsetY;
      this.vx = 0;
      this.vy = 0;
    }

    this.x = constrain(this.x, 0, width - this.size);
    this.y = constrain(this.y, 0, height - this.size);
  }

  display() {
    image(this.img, this.x, this.y, this.size, this.size);
  }

  isMouseOver() {
    return mouseX > this.x && mouseX < this.x + this.size &&
           mouseY > this.y && mouseY < this.y + this.size;
  }
}
